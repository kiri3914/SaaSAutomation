{% extends 'base.html' %}
{% load static %}
{% load cache %}
{% load date_filters %}

{% block title %}Панель управления{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/countup.js@2.0.7/dist/countUp.min.js"></script>
{% endblock %}

{% block content %}
<div class="py-6" x-data="dashboard">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Branch Selector -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                Панель управления
            </h1>
            <div class="flex items-center space-x-4">
                <!-- Селектор филиала -->
                {% if not user.is_branch_admin %}
                <div class="relative">
                    <select 
                        class="block w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                        onchange="window.location.href='?branch_id=' + this.value"
                    >
                        {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if branch.id == selected_branch_id %}selected{% endif %}>
                            {{ branch.city }} - {{ branch.address }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <!-- Кнопка создания курса -->
                <a href="{% url 'course_create' %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Создать курс
                </a>
            </div>
        </div>

        <!-- Добавим индикатор загрузки -->
        <div x-show="loading" class="flex justify-center my-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Карточка активных групп -->
            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Активные группы</h3>
                        <p class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                            <span id="total-courses" data-value="{{ total_stats.total_courses }}">0</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Карточка студентов -->
            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Активные студенты</h3>
                        <p class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                            <span id="total-students" data-value="{{ students.active_students_count|default:"0" }}">0</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Карточка курсов в наборе -->
            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2M7 7h10"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Всего студентов</h3>
                        <p class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                            <span id="upcoming-groups" data-value="{{ total_stats.total_students|default:"0" }}">0</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Карточка заполняемости -->
            <div class="card bg-white dark:bg-gray-800 p-6 rounded-lg shadow hover:shadow-lg transition-shadow duration-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <h3 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Средняя заполняемость</h3>
                        <p class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                            <span id="avg-fill-rate" data-value="{{ total_stats.avg_fill_rate|default:0 }}">0</span>%
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Секции с группами -->
        <div  class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Предстоящие группы -->
            <div class="card bg-gradient-to-br from-blue-50 to-blue-100 dark:from-gray-800 dark:to-gray-700" style="border-radius: 10px;">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 bg-blue-500 rounded-md p-3 mr-4">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                        Предстоящие группы 
                        <span class="ml-2 text-sm bg-blue-500 text-white px-2 py-1 rounded-full">
                            {{ courses.active_enrollment_groups|length }}
                        </span>
                    </h2>
                </div>
                <div class="overflow-hidden rounded-lg">
                    <table id="upcoming-groups-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-blue-500 dark:bg-blue-600">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Название</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Дата начала</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Студентов</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for group in courses.active_enrollment_groups %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        <a href="{% url 'course_detail' group.id %}" 
                                           class="hover:text-blue-600 dark:hover:text-blue-400 inline-flex items-center">
                                            {{ group.title }}
                                            <svg class="ml-1 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                            </svg>
                                        </a>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        {{ group.date_start|russian_date }}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                        {{ group.count_active_students }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Группы с началом следующего месяца -->
            <div class="card bg-gradient-to-br from-purple-50 to-purple-100 dark:from-gray-800 dark:to-gray-700" style="border-radius: 10px;">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 bg-purple-500 rounded-md p-3 mr-4">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-lg font-medium text-gray-900 dark:text-white flex items-center">
                        Собирать оплаты
                        <span class="ml-2 text-sm bg-purple-500 text-white px-2 py-1 rounded-full">
                            {{ courses.groups_starting_next_month_within_week|length }}
                        </span>
                    </h2>
                </div>
                <div class="overflow-hidden rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                        <thead class="bg-purple-500 dark:bg-purple-600">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Название</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Следующий месяц</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Сумма</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            {% for group in courses.groups_starting_next_month_within_week %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <a href="{% url 'course_detail' group.id %}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-purple-600">
                                        {{ group.title }}
                                    </a>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-purple-600">
                                    {{ group.next_month|russian_date }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        {{ group.sum_for_next_month|format_price }}  {{ group.branch.currency }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Активные группы -->
        <div class="card bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-800 dark:to-gray-700 mb-8" style="border-radius: 10px;">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 bg-green-500 rounded-md p-3 mr-4">
                    <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <h2 class="text-lg font-medium text-gray-900 dark:text-white">
                    Активные группы
                    <span class="ml-2 text-sm bg-green-500 text-white px-2 py-1 rounded-full">
                        {{ courses.active_groups_fill_rate|length }}
                    </span>
                </h2>
            </div>
            <div class="overflow-hidden rounded-lg">
                <table id="active-groups-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                    <thead class="bg-green-500 dark:bg-green-600">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Название</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Дата начала</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Студентов</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Заполненность</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for group in courses.active_groups_fill_rate %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">
                                    <a href="{% url 'course_detail' group.id %}" 
                                       class="hover:text-blue-600 dark:hover:text-blue-400 inline-flex items-center">
                                        {{ group.title }}
                                        <svg class="ml-1 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                        </svg>
                                    </a>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ group.date_start|russian_date }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                                    {{ group.count_active_students }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                    <div class="absolute top-0 left-0 h-full bg-green-600 rounded-full" 
                                         data-fill-rate="{{ group.fill_rate }}"
                                         style="width: 0%">
                                    </div>
                                </div>
                                <span class="text-xs mt-1 text-gray-500 dark:text-gray-400">{{ group.fill_rate }}%</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Информация о студентах -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Должники -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Должники</h3>
                        <span class="px-2 py-1 text-sm bg-red-100 text-red-800 rounded-full">
                            {{ students.debtors|length }}
                        </span>
                    </div>
                    <div class="space-y-4" x-data="{ showAllDebtors: false }">
                        {% for student in students.debtors %}
                        <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg"
                             x-show="showAllDebtors || {{ forloop.counter }} <= 4">
                            <div>
                                <a href="{% url 'student_detail' pk=student.id %}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-red-600">
                                    {{ student.full_name }} - {{ student.course.title }}
                                </a>
                                <div class="text-xs text-red-600">
                                    Долг: {{ student.remainder_for_current_mount|format_price }} {{ student.course.branch.currency }}
                                </div>
                            </div>
                            <div class="flex items-center space-x-4 mt-1" onclick="event.stopPropagation();">
                                {% if student.phone %}
                                <a href="tel:{{ student.phone }}" class="text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Позвонить">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                </a>
                                {% endif %}
                                
                                {% if student.whatsapp %}
                                <a href="https://wa.me/{{ student.whatsapp|cut:'+' }}" target="_blank" class="text-gray-500 hover:text-green-600 dark:hover:text-green-400" title="WhatsApp">
                                    <svg width="52" height="52" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.582 2.128 2.182-.573c.978.58 1.911.928 3.145.929 3.178 0 5.767-2.587 5.768-5.766.001-3.187-2.575-5.77-5.764-5.771zm3.392 8.244c-.144.405-.837.774-1.17.824-.299.045-.677.063-1.092-.069-.252-.08-.575-.187-.988-.365-1.739-.751-2.874-2.502-2.961-2.617-.087-.116-.708-.94-.708-1.793s.448-1.273.607-1.446c.159-.173.346-.217.462-.217l.332.006c.106.005.249-.04.39.298.144.347.491 1.2.534 1.287.043.087.072.188.014.304-.058.116-.087.188-.173.289l-.26.304c-.087.086-.177.18-.076.354.101.174.449.741.964 1.201.662.591 1.221.774 1.394.86s.274.072.376-.043c.101-.116.433-.506.549-.68.116-.173.231-.145.39-.087s1.011.477 1.184.564c.173.087.289.129.332.202.043.073.043.423-.101.827z"/>
                                    </svg>
                                </a>
                                {% endif %}
                                
                                {% if student.telegram %}
                                <a href="https://t.me/{{ student.telegram|cut:'@' }}" target="_blank" class="text-gray-500 hover:text-blue-500 dark:hover:text-blue-400" title="Telegram">
                                    <svg class="w-7 h-7" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm4.474 8.467l-1.414 6.669c-.106.5-.399.617-.809.384l-2.236-1.647-1.078 1.038a.562.562 0 01-.45.187l.161-2.281 4.156-3.756c.18-.163-.04-.253-.28-.09L7.562 12.96l-2.223-.696c-.483-.151-.491-.483.101-.713l8.669-3.339c.406-.151.764.089.889.7z"/>
                                    </svg>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-sm text-gray-500 text-center py-4">
                            Нет должников
                        </div>
                        {% endfor %}
                        
                        {% if students.debtors|length > 5 %}
                        <div class="text-center mt-4">
                            <button 
                                @click="showAllDebtors = !showAllDebtors"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                            >
                                <span x-text="showAllDebtors ? 'Скрыть' : 'Показать еще'"></span>
                                <svg 
                                    class="ml-2 h-4 w-4 transition-transform duration-200"
                                    :class="{ 'transform rotate-180': showAllDebtors }"
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Студенты без договора -->
            <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Студенты без договора</h3>
                        <span class="px-2 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">
                            {{ students.no_contract_students|length }}
                        </span>
                    </div>
                    <div class="space-y-4" x-data="{ showAll: false }">
                        {% for student in students.no_contract_students %}
                        <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg student-card"
                             x-show="showAll || {{ forloop.counter }} <= 6">
                            <div>
                                <a href="{% url 'student_detail' student.id %}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-blue-600">
                                    {{ student.full_name }} - {{ student.course.title }}
                                </a>
                            </div>
                            <a href="{% url 'create_contract' student.id %}" class="text-sm text-blue-600 hover:text-blue-800">
                                Подписать
                            </a>
                        </div>
                        {% empty %}
                        <div class="text-sm text-gray-500 text-center py-4">
                            Нет студентов без договора
                        </div>
                        {% endfor %}
                        
                        {% if students.no_contract_students|length > 5 %}
                        <div class="text-center mt-4">
                            <button 
                                @click="showAll = !showAll"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                            >
                                <span x-text="showAll ? 'Скрыть' : 'Показать еще'"></span>
                                <svg 
                                    class="ml-2 h-4 w-4 transition-transform duration-200"
                                    :class="{ 'transform rotate-180': showAll }"
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Последние студенты -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg mb-8">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">Последние студенты</h3>
                    <div class="flex space-x-2">
                        <span class="px-2 py-1 text-sm bg-green-100 text-green-800 rounded-full">
                            Всего активных: {{ students.active_students_count|default:"0" }}
                        </span>
                        <span class="px-2 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">
                            За месяц: {{ students.count_students_last_month|default:"0" }}
                        </span>
                    </div>
                </div>
                <div class="space-y-4">
                    {% for student in students.last_students %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <a href="{% url 'student_detail' pk=student.id %}" class="text-sm font-medium text-gray-900 dark:text-white hover:text-blue-600">
                                {{ student.full_name }}
                            </a>
                            <div class="text-xs text-gray-500">
                                Остаток: 
                                <span class="{% if student.remainder_for_current_mount > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                    {{ student.remainder_for_current_mount|format_price }}
                                </span>
                            </div>
                        </div>
                        <a href="{% url 'course_detail' student.course.pk %}" class="text-sm text-blue-600 hover:text-blue-800">
                            Курс →
                        </a>
                    </div>
                    {% empty %}
                    <div class="text-sm text-gray-500 text-center py-4">
                        Нет данных о последних студентах
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Простая функция анимации чисел
    function animateValue(element, start, end, duration, decimals = 0) {
        const range = end - start;
        const increment = range / (duration * 60); // 60fps
        let current = start;
        const timer = setInterval(function() {
            current += increment;
            if ((increment >= 0 && current >= end) || (increment < 0 && current <= end)) {
                clearInterval(timer);
                current = end;
            }
            element.textContent = decimals ? current.toFixed(decimals) : Math.round(current);
        }, 1000 / 60);
    }

    // Анимируем все числа
    const elements = {
        'total-courses': 0,
        'total-students': 0,
        'upcoming-groups': 0,
        'avg-fill-rate': 1  // 1 десятичный знак
    };

    Object.entries(elements).forEach(([id, decimals]) => {
        const element = document.getElementById(id);
        if (element) {
            const endValue = parseFloat(element.getAttribute('data-value'));
            animateValue(element, 0, endValue, 1, decimals);
        }
    });

    // Анимация прогресс-баров
    const progressBars = document.querySelectorAll('[data-fill-rate]');
    progressBars.forEach(bar => {
        const fillRate = parseFloat(bar.getAttribute('data-fill-rate'));
        setTimeout(() => {
            bar.style.transition = 'width 1s ease-in-out';
            bar.style.width = Math.min(fillRate, 100) + '%';
        }, 100);
    });
});
</script>
{% endblock %} 